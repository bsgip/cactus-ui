{% extends "base.html" %}

{% block title %}Certificate - CACTUS{% endblock %}

{% block content %}
<h2>User Configuration</h2>

<p>
    The following configuration options will apply to all future <a href="{{ url_for('runs_page') }}">Runs</a> that are
    created.
</p>

<hr>

{% if pwd %}
<div class="alert alert-warning mt-3">
    <strong>Generated a new certificate (.p12). This passphrase will not be shown again:</strong> {{ pwd }}
</div>
{% endif %}

{% if error %}
<div class="alert alert-danger mt-3">
    <strong>Error:</strong> {{ error }}
</div>
{% elif aggregator_certificate_expiry is none and device_certificate_expiry is none %}
<div class="alert alert-danger" role="alert">
    No client certificates have been generated. Please generate one below, otherwise you will be unable to start a a
    test run
</div>
{% elif not is_device_cert and aggregator_certificate_expiry is none %}
<div class="alert alert-danger" role="alert">
    You have opted to use an aggregator certificate but there is no valid aggregate certificate on record. Please
    generate one below.
</div>
{% elif is_device_cert and device_certificate_expiry is none %}
<div class="alert alert-danger" role="alert">
    You have opted to use an device certificate but there is no valid device certificate on record. Please generate one
    below.
</div>
{% endif %}

{% if not run_groups %}
<div class="alert alert-danger" role="alert">
    There are no Run Groups configured. Please create one below in order to start testing.
</div>
{% endif %}



<div class="row">
    <div class="card-group">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Manage Client Certificates</h5>
                <p class="card-text">Each test run will have <strong>either</strong> a device or aggregator certificate
                    installed. A device certificate can only create a single <code>EndDevice</code> whose
                    <code>lfdi</code> and <code>sfdi</code> must match the device certificate exactly. An aggregator
                    certificate can instead manage multiple <code>EndDevice</code> instances with relaxed rules around
                    <code>lfdi</code> and <code>sfdi</code> values.
                </p>

                <p class="card-text">
                    All certificates will be signed by the CACTUS certificate authority.
                <form method="POST" action="{{ url_for('config_page') }}">
                    <input type="hidden" name="certificate" , value="authority">
                    <div class="btn-group" role="group">
                        <button type="submit" name="action" value="download-ca" class="btn btn-outline-secondary">
                            <i class="fas fa-download"></i> Download CA Certificate
                        </button>
                    </div>
                </form>
                </p>

                <table class="table" style="max-width: 650px;">
                    <tbody>
                        <tr {% if not is_device_cert %}class="table-success" {% endif %}>
                            <td>Aggregator Certificate</td>
                            <td id="aggregator-expiry">Not generated</td>

                            <td>
                                <form method="POST" action="{{ url_for('config_page') }}">
                                    <input type="hidden" name="certificate" , value="aggregator">
                                    <div class="btn-group" role="group">
                                        {% if aggregator_certificate_expiry %}
                                        <button type="submit" name="action" value="download-certs"
                                            class="btn btn-outline-primary">
                                            <i class="fas fa-download"></i> Download
                                        </button>
                                        {% endif %}
                                        <button type="submit" name="action" value="refresh"
                                            class="btn btn-outline-danger">
                                            <i class="fas fa-sync-alt"></i>
                                            {% if aggregator_certificate_expiry %}
                                            Refresh
                                            {% else %}
                                            Generate
                                            {% endif %}
                                        </button>


                                    </div>
                                </form>
                            </td>
                        </tr>
                        <tr {% if is_device_cert %}class="table-success" {% endif %}>
                            <td>Device Certificate</td>
                            <td id="device-expiry">Not generated</td>
                            <td>
                                <form method="POST" action="{{ url_for('config_page') }}">
                                    <input type="hidden" name="certificate" , value="device">
                                    <div class="btn-group" role="group">
                                        {% if device_certificate_expiry %}
                                        <button type="submit" name="action" value="download-certs"
                                            class="btn btn-outline-primary">
                                            <i class="fas fa-download"></i> Download
                                        </button>
                                        {% endif %}
                                        <button type="submit" name="action" value="refresh"
                                            class="btn btn-outline-danger">
                                            <i class="fas fa-sync-alt"></i>
                                            {% if device_certificate_expiry %}
                                            Refresh
                                            {% else %}
                                            Generate
                                            {% endif %}
                                        </button>


                                    </div>
                                </form>
                            </td>
                        </tr>
                    </tbody>
                </table>


                <p class="card-text"><small class="text-body-secondary">Currently using <strong>{{'Device' if
                            is_device_cert else 'Aggregator'}}</strong>
                        certificate</small></p>

                <form method="POST" action="{{ url_for('config_page') }}">
                    <input type="hidden" name="certificate" , value="{{'aggregator' if is_device_cert else 'device'}}">
                    <button type="submit" name="action" value="setcert" class="btn btn-primary">
                        <i class="fas fa-arrow-right-arrow-left"></i> Swap to {{'Aggregator' if
                        is_device_cert else 'Device'}} certificate
                    </button>
                </form>
            </div>
        </div>

    </div>
</div>

<br>

<div class="row">
    <div class="card-group">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Private Enterprise Number (PEN)</h5>
                <p class="card-text">A Private Enterprise Number (PEN) is a numeric identifier for an organisation,
                    individual or other entity. CSIP-Aus requires clients to encode a PEN within various requests to the
                    server.</p>
                <p class="card-text">A PEN can be obtained from <a href="https://www.iana.org/">IANA</a> for free from
                    the following <a href="https://www.iana.org/assignments/enterprise-numbers/">link</a>.</p>
                <form method="POST" action="{{ url_for('config_page') }}">
                    <input type="number" step="any" , min="1" , max="4294967295" class="form-control" id="inputPen"
                        name="pen" aria-describedby="penHelp" placeholder="Enter PEN (e.g. 123456)" value="{{ pen }}">
                    <br>
                    <button type="submit" name="action" value="setpen" class="btn btn-primary">
                        <i class="fas fa-pen"></i> Update PEN
                    </button>
                </form>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Subscription Notification Domain</h5>
                <p class="card-text">This domain will be authorised for receiving subscription notifications.</p>
                <p class="card-text"><b>Note:</b> Attempts to register notification URIs outside of this domain will be
                    rejected.</p>
                <br>
                <br>
                <form method="POST" action="{{ url_for('config_page') }}">
                    <input type="text" class="form-control" id="inputDomain1" name="subscription_domain"
                        aria-describedby="domainHelp" placeholder="Enter a FQDN (e.g. my.example.com)"
                        value="{{ domain }}">
                    <br>
                    <button type="submit" name="action" value="setsubscribeddomain" class="btn btn-primary">
                        <i class="fas fa-pen"></i> Update Domain
                    </button>
                </form>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">DeviceCapability URI</h5>
                <p class="card-text">The DeviceCapability URI can set to be either "static" or "dynamic".</p>
                <p class="card-text">A "static" value results in sharing the same DeviceCapability URI across all test
                    runs. <b>Note:</b> when "static" is set only <i>one</i> test run can be active at any given time.
                </p>
                <p>
                    {% if static_uri_example %}
                    Currently <span class="badge text-bg-primary">Static</span><br><u>{{static_uri_example}}</u>
                    {% else %}
                    Currently <span class="badge text-bg-primary">Dynamic</span>
                    {% endif %}
                </p>

                <br>

                <form method="POST" action="{{ url_for('config_page') }}">
                    <input type="hidden" name="static_uri" , value="{{ not static_uri }}">

                    <button type="submit" name="action" value="setstaticuri" class="btn btn-primary">
                        <i class="fas fa-arrow-right-arrow-left"></i>
                        {% if static_uri %}
                        Swap to dynamic URI
                        {% else %}
                        Swap to static URI
                        {% endif %}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<br>

<div class="row">
    <div class="card-group">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Run Groups</h5>
                <p class="card-text">Each run group represents progress towards certification for a single device /
                    client.</p>

                {% if not run_groups %}
                <p class="card-text"><strong>There doesn't seem to be anything here...</strong></p>
                {% endif %}

                <table class="table align-middle">
                    <tbody>
                        {% for rg in run_groups %}
                        <tr>
                            <td>
                                <form method="POST" action="{{ url_for('config_page') }}">
                                    <input type="hidden" name="run_group_id" value="{{ rg.run_group_id }}">
                                    <div class="input-group">
                                        <input type="text" name="name" class="form-control" value="{{ rg.name }}">
                                        <button type="submit" name="action" value="updaterungroup"
                                            class="btn btn-outline-primary">
                                            <i class="fas fa-floppy-disk"></i>
                                        </button>
                                    </div>

                                </form>
                            </td>
                            <td><code>{{ rg.csip_aus_version }}</code></td>
                            <td>{{ rg.total_runs }} total run(s)</td>
                            <td>
                                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal"
                                    data-bs-target="#delmodal-{{ rg.run_group_id }}">
                                    <i class="fas fa-trash-can"></i> Delete
                                </button>

                                <div class="modal fade" id="delmodal-{{ rg.run_group_id }}" tabindex="-1"
                                    aria-labelledby="delmodal-{{ rg.run_group_id }}-label" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h1 class="modal-title fs-5" id="delmodal-{{ rg.run_group_id }}-label">
                                                    Confirm Delete</h1>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                    aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                You are about to permanently delete <strong>{{ rg.name }}</strong>
                                                <code>{{ rg.csip_aus_version }}</code>. Once deleted, this group and the
                                                associated {{ rg.total_runs }} run(s) will be gone forever.
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary"
                                                    data-bs-dismiss="modal">Cancel</button>
                                                <form method="POST" action="{{ url_for('config_page') }}">
                                                    <input type="hidden" name="run_group_id"
                                                        value="{{ rg.run_group_id }}">

                                                    <button type="submit" name="action" value="deleterungroup"
                                                        class="btn btn-danger">
                                                        <i class="fas fa-trash-can"></i> Delete {{ rg.name }}
                                                    </button>

                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <form method="POST" action="{{ url_for('config_page') }}">
                    <input type="hidden" name="action" value="createrungroup">
                    <div class="btn-group" role="group">
                        {% for csip_aus_version in csip_aus_versions %}
                        <button type="submit" name="version" value="{{ csip_aus_version.version }}"
                            class="btn btn-outline-primary"> <i class="fas fa-plus"></i> New {{ csip_aus_version.version
                            }} Group</button>
                        {% endfor %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    addEventListener("load", (event) => {
        const aggregator_expiry_raw = "{{ aggregator_certificate_expiry if aggregator_certificate_expiry else '' }}";
        const device_expiry_raw = "{{ device_certificate_expiry if device_certificate_expiry else '' }}";

        if (aggregator_expiry_raw) {
            d = new Date(Date.parse(aggregator_expiry_raw))
            document.getElementById('aggregator-expiry').innerHTML = `Expires ${formatRelativeDate(d)}`;
        }

        if (device_expiry_raw) {
            d = new Date(Date.parse(device_expiry_raw));
            document.getElementById('device-expiry').innerHTML = `Expires ${formatRelativeDate(d)}`;
        }
    });
</script>

{% endblock %}