{% extends "base.html" %}

{% block title %}Runs - CACTUS{% endblock %}

{% block content %}

{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}

<div class="max-page-height" style="padding-top:10px; display: flex; flex-direction: column;">
    <div style="display: flex;">
        {% if run_groups|length < 2 %} {% if active_run_group %} <h2>Runs for {{ active_run_group.name }}</h2>
            {% endif %}
            {% else %}

            <h2>Runs for </h2>
            <div class="dropdown" style="margin-left: 10px;">
                <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    {{ active_run_group.name }}
                </button>
                <ul class="dropdown-menu">
                    {% for rg in run_groups %}
                    {% if rg.run_group_id != run_group_id %}
                    <li><a class="dropdown-item"
                            href="{{ url_for('group_runs_page', run_group_id=rg.run_group_id) }}">{{rg.name}}</a></li>
                    {% endif %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
    </div>

    <hr>

    <div class="row" style="flex: 1; overflow: hidden;">
        <div class="col procedure-col">
            <h5>Procedures</h5>

            <div class="procedure-container">

                <div class="card" style="border-radius: 0; border-bottom: none;">
                    <div class="list-group list-group-flush">
                        <a id="active-runs-button" href="#"
                            class="procedure-btn list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                            style="border-radius: 0; width:100%">
                            Active Runs
                        </a>
                    </div>
                </div>

                <div
                    style="display: flex; flex-direction: row; align-items: center; margin-top: 3px; margin-bottom: 3px;">
                    <p id="filter-summary" style="flex: 1; margin: 0;">Showing ALL compliance classes</p>
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal"
                        data-bs-target="#filter-modal"><i class="fas fa-sliders"></i></button>
                </div>

                <div class="modal fade" id="filter-modal" tabindex="-1" aria-labelledby="filter-modal-label"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="filter-modal-label">Filter Compliance Classes</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="filterform">
                                    <p>The following compliance classes are defined in TS 5573:2025 (Table 12.5)</p>
                                    {% for c in classes %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="{{ c.name }}"
                                            name="{{ c.name }}" id="check-{{ c.name }}"
                                            oninput="filterProceduresCheckHandler()" checked>
                                        <label class="form-check-label" for="check-{{ c.name }}"><strong>({{ c.name
                                                }})</strong> {{
                                            c.description }}</label>
                                    </div>
                                    {% endfor %}
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button id="filter-btn-all" type="button" class="btn btn-outline-primary"
                                    onclick="filterAllHandler()">Select ALL</button>
                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>


                {% for gp in grouped_procedures %}
                <div id="{{gp.slug}}" class="card" style="border-radius: 0; border-bottom: none;">
                    <button class="btn btn-success text-start" type="button" data-bs-toggle="collapse"
                        data-bs-target="#{{gp.slug}}-body" style="border-radius: 0;">

                        <i class="fa fas"></i> {{gp.category}}

                    </button>
                    <div class="list-group list-group-flush collapse show" id="{{gp.slug}}-body">
                        {% for procedure in gp.summaries %}
                        <a href="#" id="{{ procedure.test_procedure_id }}" _description="{{ procedure.description }}"
                            _classes="{{ ','.join(procedure.classes) }}"
                            class="procedure-btn list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            {{procedure.test_procedure_id }}

                            {% if procedure.run_count > 0 %}
                            {% if procedure.latest_all_criteria_met == true %}
                            <span class="badge text-bg-success">{{ procedure.run_count }}</span>
                            {% elif procedure.latest_all_criteria_met == false %}
                            <span class="badge text-bg-danger">{{ procedure.run_count }}</span>
                            {% else %}
                            <span class="badge text-bg-secondary">{{ procedure.run_count }}</span>
                            {% endif %}
                            {% endif %}

                        </a>
                        {% endfor %}
                    </div>

                </div>
                {% endfor %}
            </div>
        </div>
        <div class="col">
            <div style="display:flex; padding-top: 5px; padding-bottom: 5px; align-items: center;">
                <h5 id="runs-title" style="flex: 1;">Runs</h5>
                <div id="runs-actions" style="margin-left: 10px;"></div>
            </div>
            <div class="runs-table-container">
                <table class="table">
                    <tbody id="runs-table-body">
                        <tr>
                            <td>Start by selecting a test procedure to either start a new run or view historical runs.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<style>
    html,
    body {
        height: 100%;
        margin: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .hidden {
        display: none !important;
    }

    .search {
        width: 100%;
        margin-top: 10px;
        margin-bottom: 5px;
    }

    .main-footer {
        margin-top: 0 !important;
    }

    .main-content {
        flex: 1;
        overflow: hidden;
        padding: 0 !important;
    }

    .max-page-height {
        height: 100%;
        overflow: hidden;
    }

    .col {
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .procedure-col {
        max-width: 400px;
        min-width: 200px;
        overflow: auto;
    }

    .procedure-container {
        flex: 1;
    }

    .runs-table-container {
        margin-top: 5px;
        flex: 1;
        overflow: auto;
    }

    [data-bs-toggle="collapse"] .fa:before {
        content: "\f139";
    }

    [data-bs-toggle="collapse"].collapsed .fa:before {
        content: "\f13a";
    }
</style>

<script>
    const classesByTest = JSON.parse(atob("{{ classes_by_test_b64 }}"));
    const classesByCategory = JSON.parse(atob("{{ classes_by_category_b64 }}"));
    const allClasses = [
        {% for c in classes %}"{{ c.name }}", {% endfor %}
    ];
    const isAdminView = "{{ is_admin_view }}" === 'True';

    function filterByComplianceClass(classesByGroup, filters) {
        let filtered_count = 0
        for (const [id, classes] of Object.entries(classesByGroup)) {
            const element = document.getElementById(id);
            if (element === null) {
                filtered_count++;
                continue;
            }
            if (filters.filter(element => classes.includes(element)).length > 0) {
                element.classList.remove("hidden");
            } else {
                element.classList.add("hidden");
                filtered_count++;
            }
        }
        const all_filtered = filtered_count === Object.entries(classesByGroup).length;
        return all_filtered
    }

    function filterProcedures(filters) {
        const allTestsFilteredOut = filterByComplianceClass(classesByTest, filters);
        filterByComplianceClass(classesByCategory, filters);

        enabledFilterCount = filters.length;
        if (enabledFilterCount < allClasses.length) {

            document.getElementById("filter-btn-all").innerHTML = "Select ALL";
            if (enabledFilterCount == 0) {
                document.getElementById("filter-summary").innerHTML = `Showing NO compliance classes`;
            } else if (enabledFilterCount < 5) {
                document.getElementById("filter-summary").innerHTML = `Showing ${filters.join(", ")}`;
            } else {
                document.getElementById("filter-summary").innerHTML = `Showing ${enabledFilterCount} compliance classes`;
            }


        } else {
            document.getElementById("filter-btn-all").innerHTML = "Select NONE";
            document.getElementById("filter-summary").innerHTML = "Showing ALL compliance classes";
        }

    }

    function getSelectedFilters() {
        filterForm = document.forms.filterform;
        return Array.from(new FormData(filterForm).values())
    }

    function filterAllHandler() {
        enabledFilterCount = getSelectedFilters().length;
        selecting = enabledFilterCount < allClasses.length; // are we enabling or disabling all the checks

        for (let input of document.forms.filterform.querySelectorAll("input")) {
            if (input.checked !== selecting) {
                input.checked = selecting
            }
        }

        filterProceduresCheckHandler();
    }

    function filterProceduresCheckHandler() {
        filterProcedures(getSelectedFilters());
    }

    function statusToBtn(run_id, run_status, isAdminView) {
        if (isAdminView) {
            switch (run_status) {
                case "initialised":
                case "started":
                        // admin shouldn't be starting or finalizing tests for other users.
                        // button is disabled
                        return `<form method="POST" action="{{ url_for('group_runs_page', run_group_id=run_group_id) }}">
                        <input type="hidden" name="run_id" value="${run_id}">
                        <input type="hidden" name="action" value="artifact">
                        <button disabled type="submit" class="btn btn-secondary">Running...</button>
                    </form>`;
                default:
                    return `<form method="POST" action="{{ url_for('group_runs_page', run_group_id=run_group_id) }}">
                    <input type="hidden" name="run_id" value="${run_id}">
                    <input type="hidden" name="action" value="artifact">
                    <button type="submit" class="btn btn-secondary">Download</button>
                </form>`;
            }
        }
            switch (run_status) {
                case "initialised":
                    return `<form method="POST" action="{{ url_for('group_runs_page', run_group_id=run_group_id) }}">
                    <input type="hidden" name="run_id" value="${run_id}">
                    <input type="hidden" name="action" value="start">
                    <button type="submit" class="btn btn-primary">Start</button>
                </form>`;
                case "started":
                    return `<form method="POST" action="{{ url_for('group_runs_page', run_group_id=run_group_id) }}">
                    <input type="hidden" name="run_id" value="${run_id}">
                    <input type="hidden" name="action" value="finalise">
                    <button type="submit" class="btn btn-warning">Finalise</button>
                </form>`;
                default:
                    return `<form method="POST" action="{{ url_for('group_runs_page', run_group_id=run_group_id) }}">
                    <input type="hidden" name="run_id" value="${run_id}">
                    <input type="hidden" name="action" value="artifact">
                    <button type="submit" class="btn btn-secondary">Download</button>
                </form>`;
            }
    }

    function handleNewRuns(rawRunsJson) {
        const page = JSON.parse(rawRunsJson);
        const runs = page.items
        if (runs.length === 0) {
            handleRunsEmpty();
            return;
        }

        fragments = runs.map(r => {
            let row_class = "";
            let icon = "";
            switch (r.all_criteria_met) {
                case null:
                    if (r.status == "initialised" || r.status == "started") {
                        row_class = "table-info";
                    } else {
                        icon = `<span class="text-secondary"><i class="fas fa-question"></i></span>`;
                    }
                    break
                case true:
                    row_class = "table-success";
                    icon = `<span class="text-success"><i class="fas fa-check"></i></span>`;
                    break;
                default:
                    row_class = "table-danger";
                    icon = `<span class="text-danger"><i class="fas fa-x"></i></span>`;
                    break;

            }
            const created = new Date(Date.parse(r.created_at));
            return `
                <tr class="${row_class}">
                    <td><a href="/run/${r.run_id}">${r.run_id}</a></td>
                    <td>${formatDate(created)}<br><small class="text-body-secondary">(${formatRelativeDate(created)})<small></td>
                    <td>${r.status}</td>
                    <td>${icon}</td>
                    <td>${statusToBtn(r.run_id, r.status, isAdminView)}</td>
                    <td>
                        <form method="POST" action="{{ url_for('group_runs_page', run_group_id=run_group_id) }}">
                            <input type="hidden" name="run_id" value="${r.run_id}">
                            <input type="hidden" name="action" value="delete">
                            <button type="submit" class="btn btn-outline-danger" onclick="handleButtonClick(event)"><i class="fas fa-trash-can"></i></button>
                        </form>
                    </td>
                </tr>
            `
        });
        document.getElementById("runs-table-body").innerHTML = fragments.join("")
    }

    function handleRunsError(status, error) {
        document.getElementById("runs-table-body").innerHTML = `
            <tr class="table-danger">
                <td>${error}</td>
            </tr>
        `
    }

    function handleRunsEmpty() {
        document.getElementById("runs-table-body").innerHTML = `
            <tr>
                <td>No runs were returned.</td>
            </tr>
        `
    }

    function handleRunsLoading() {
        document.getElementById("runs-table-body").innerHTML = `
            <tr>
                <td>
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </td>
            </tr>
        `
    }

    function loadProcedureRuns(test_procedure_id) {
        handleRunsLoading();

        xhrRequest(`/run_group/{{ run_group_id }}/procedure_runs/${test_procedure_id}`, handleNewRuns, handleRunsError);
    }

    function loadActiveRuns() {
        handleRunsLoading();


        xhrRequest(`/run_group/{{ run_group_id }}/active_runs`, handleNewRuns, handleRunsError);
    }

    function handleButtonClick(e) {
        e.target.innerHTML = `<div class="spinner-border spinner-border-sm" role="status"></div>`;
        e.target.disabled = true;
        e.target.closest('form').submit();
    }

    function handleProcedureButtonClick(e) {
        const test_procedure_id = this.id;
        const description = this.getAttribute("_description")
        const classes = this.getAttribute("_classes") ? this.getAttribute("_classes").split(",") : [];

        // update active class
        document.querySelectorAll(".procedure-btn").forEach(el => el.classList.remove('active'));
        this.classList.add('active');

        // update title and buttons
        if (this.id === "active-runs-button") {
            // active runs is a special case
            document.getElementById("runs-title").innerHTML = "Active Runs";
            document.getElementById("runs-actions").innerHTML = "";
            loadActiveRuns()
        } else {
            // handle the other test procedure buttons
            document.getElementById("runs-title").innerHTML = `<a href="/procedure/${test_procedure_id}">${test_procedure_id}</a> ${description}`;

            disabled = isAdminView ? "Disabled" : ""
            document.getElementById("runs-actions").innerHTML = `<form method="POST" action="{{ url_for('group_runs_page', run_group_id=run_group_id) }}">
                <input type="hidden" name="test_procedure_id" value="${test_procedure_id}">
                <input type="hidden" name="action" value="initialise">
                <button ${disabled} type="submit" class="btn btn-primary" onclick="handleButtonClick(event)">New Test Run</button>
            </form>`;

            loadProcedureRuns(test_procedure_id)
        }
    }

    addEventListener("load", (event) => {
        // Install onclick handlers for procedure btns
        document.querySelectorAll(".procedure-btn").forEach(el => el.onclick = handleProcedureButtonClick);

        // Start the page loaded with the active procedures
        handleProcedureButtonClick.call(document.getElementById("active-runs-button"))

        // Enable collapsing procedure cards
        // const collapseElementList = document.querySelectorAll('.collapse')
        // const collapseList = [...collapseElementList].map(collapseEl => new bootstrap.Collapse(collapseEl))

        // Apply filter correctly of page (re)load
        filterProceduresCheckHandler()
    });


</script>


{% endblock %}