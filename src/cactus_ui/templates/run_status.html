{% extends "base.html" %}

{% block title %}Run Status {{ run_id }} - Cactus{% endblock %}

{% block content %}


{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}

<div id="error-div"></div>
{% if run_is_live %}

<div class="row justify-content-center">
    <div class="card status-container">
        <div class="card-body">
            <h5 class="card-title">Run {{ run_id }} ({{ run_status }})</h5>

            <p class="card-text">
                <code style="user-select: all;">{{ run_test_uri }}</code>
            </p>

            {% if run_status == 'initialised' %}
            <div id="update-initialised-card"></div>
            {% elif run_status == 'started' %}
            <p class="card-text">The test is now underway - the server will have loaded any initial preconditions
                (eg: DERControls) and its now time for your client to respond appropriately. When you're ready to
                end the test, press the Finalise button</p>
            <form method="POST" action="{{ url_for('run_status_page', run_id=run_id) }}">
                <input type="hidden" name="action" value="finalise">
                <button type="submit" class="btn btn-warning" onclick="handleButtonClick(event)">Finalise</button>
            </form>
            {% endif %}

        </div>
    </div>
</div>
<br>
<div class="row justify-content-center">
    <div class="card status-container">
        <div class="card-body">
            <h5 class="card-title"><a href="{{ url_for('procedure_yaml_page', test_procedure_id=run_procedure_id) }}">
                    {{ run_procedure_id }}
                </a></h5>
            <table class="table">
                <tbody id="update-general-table"></tbody>
            </table>
        </div>
    </div>
</div>
<br>
<div class="row justify-content-center">
    <div class="card status-container" id="precondition-checks-card">
        <div class="card-body">
            <h5 class="card-title">Precondition Checks</h5>
            <table class="table">
                <tbody id="update-precondition-checks-table"></tbody>
            </table>
        </div>
    </div>
</div>
<br>
<div class="row justify-content-center">
    <div class="card status-container ">
        <div class="card-body">
            <h5 class="card-title">Current Criteria</h5>
            <table class="table">
                <tbody id="update-criteria-table"></tbody>
            </table>
        </div>
    </div>
</div>
<br>
<div class="row justify-content-center">
    <div class="card status-container ">
        <div class="card-body">
            <h5 class="card-title">Steps</h5>
            <div id="step-instructions"></div>
            <table class="table">
                <tbody id="update-steps-table"></tbody>
            </table>
        </div>
    </div>
</div>
<br>
<div class="row justify-content-center">
    <div class="card status-container ">
        <div class="card-body">
            <h5 class="card-title">Timeline</h5>
            <div id="timelineError" class="alert alert-info">No timeline (DERControl / Reading) data is available.</div>
            <canvas id="timelineChart"></canvas>
        </div>
    </div>
</div>
<br>
<div class="row justify-content-center">
    <div class="card status-container ">
        <div class="card-body">
            <h5 class="card-title">CSIP-Aus Requests</h5>
            <table class="table">
                <tbody id="update-requests-table"></tbody>
            </table>
        </div>
    </div>
</div>
<br>
<div class="row justify-content-center">
    <div class="card status-container ">
        <div class="card-body">
            <h5 class="card-title">Envoy Logs</h5>
            <pre id="update-log-envoy">Loading...</pre>
        </div>
    </div>
</div>

{% else %}

<div class="row">
    <h2>Run {{ run_id }} has finalised</h2>
    <div class="alert alert-danger" role="alert">
        It appears that this run is no longer active. All results are available as test artifacts.
    </div>

    <form method="POST" action="{{ url_for('run_status_page', run_id=run_id) }}">
        <input type="hidden" name="action" value="artifact">
        <button type="submit" class="btn btn-primary">Download Artifacts</button>
    </form>
</div>



{% endif %}


<style>
    .status-container {
        max-width: 1000px;
        max-height: 600px;
        overflow-y: auto;

    }
</style>

<script>
    var timelineChart = null;

    function handleButtonClick(e) {
        e.target.innerHTML = `<div class="spinner-border spinner-border-sm" role="status"></div>`;
        e.target.disabled = true;
        e.target.closest('form').submit();
    }

    function generalTableBody(status) {
        fragments = [];

        if (status.timestamp_start) {
            startTime = new Date(Date.parse(status.timestamp_start))
            fragments.push(`
                <tr>
                    <th scope="row">Started</th>
                    <td>${formatDate(startTime)} (${formatRelativeDate(startTime)})</td>
                </tr>`
            );
        }

        if (status.timestamp_initialise) {
            init_time = new Date(Date.parse(status.timestamp_initialise))
            fragments.push(`
                <tr>
                    <th scope="row">Created</th>
                    <td>${formatDate(init_time)} (${formatRelativeDate(init_time)})</td>
                </tr>`
            );
        }

        const timestamp = status.last_client_interaction?.timestamp ?? null;
        if (timestamp) {
            interaction_time = new Date(Date.parse(timestamp));
            fragments.push(`
                <tr>
                    <th scope="row">Last Interaction</th>
                    <td>${formatDate(interaction_time)} (${formatRelativeDate(interaction_time)})</td>
                </tr>`
            );
        }

        fragments.push(`
            <tr>
                <th scope="row">Summary</th>
                <td>${status.status_summary}</td>
            </tr>`
        );

        return fragments;
    }

    function preconditionChecksTableBody(preconditionChecks) {
        fragments = []
        for (const c of preconditionChecks) {
            color = c.success ? "success" : "danger";
            icon = c.success ? "check" : "x";
            fragments.push(`
                <tr>
                    <th scope="row">${c.type}</th>
                    <td><span class="text-${color}"><i class="fas fa-${icon}"></i></span></td>
                    <td>${c.details}</td>
                </tr>
            `)
        }
        return fragments
    }

    function criteriaTableBody(criteria) {
        const fragments = []
        for (const c of criteria) {
            color = c.success ? "success" : "danger";
            icon = c.success ? "check" : "x";
            fragments.push(`
                <tr>
                    <th scope="row">${c.type}</th>
                    <td><span class="text-${color}"><i class="fas fa-${icon}"></i></span></td>
                    <td>${c.details}</td>
                </tr>
            `)
        }
        return fragments
    }

    function stepStatusTableBody(stepStatus) {
        fragments = []
        for (const [step, status] of Object.entries(stepStatus)) {
            let color = ""
            let icon = ""
            switch (status) {
                case 0:
                    //PENDING
                    color = "secondary"
                    icon = "minus"
                    break;
                case 1:
                    //ACTIVE
                    color = "primary"
                    icon = "play"
                    break;
                case 2:
                    //RESOLVED
                    color = "success"
                    icon = "check"
                    break;

            }
            fragments.push(`
                <tr>
                     <th scope="row">${step}</th>
                     <td><span class="text-${color}"><i class="fas fa-${icon}"></i></span></td>
                </tr>`);
        }

        return fragments
    }

    function requestsTableBody(requests) {
        if (requests.length == 0) {
            return [`
            <tr>
                <th scope="row">No requests received</th>
                <td></td>
                <td></td>
                <td></td>
            </tr>`];
        }

        fragments = []
        for (const r of requests) {
            d = new Date(Date.parse(r.timestamp))
            statusColor = r.status < 200 || r.status > 299 ? "danger" : "success"
            schemaColor = r.body_xml_errors.length ? "danger" : "success"
            schemaText = r.body_xml_errors.length ? "XSD Errors" : "XSD Valid"
            stepName = r.step_name === "Unmatched" ? "" : r.step_name

            fragments.push(`
            <tr>
                <th scope="row">${formatDate(d)}</th>
                <td>${r.method} ${r.path} <span class="badge text-bg-${statusColor}">${r.status}</span></td>
                <td>${stepName}</td>
                <td><span class="badge text-bg-${schemaColor}">${schemaText}</span></td>
            </tr>`);
        }

        return fragments
    }

    function alertBanner(message) {
        return `
        <div class="alert alert-primary" role="alert">
            ${message}
        </div>`;
    }

    function showCommsError(message) {
        errorEl = document.getElementById('error-div')
        if (message) {
            errorEl.innerHTML = `<div class="alert alert-danger" role="alert">${message}</div>`;
        } else {
            errorEl.innerHTML = "";
        }

    }

    function getStepInstructions(instructions) {
        fragments = []
        fragments.push(`
        <p>
            <ul>
        `);
        for (const instruction of instructions) {
            fragments.push(`<li>${instruction}</li>`)
        }
        fragments.push(`
            </ul>
        </p>`);
        return fragments.join("");
    }

    function initialisedCardBody(instructions) {
        fragments = []

        const startButton = `
        <form method="POST" action="{{ url_for('run_status_page', run_id=run_id) }}">
            <input type="hidden" name="action" value="start">
            <button type="submit" class="btn btn-primary" onclick="handleButtonClick(event)">Start</button>
        </form>`;

        if (instructions.length === 0) {
            fragments.push(`
            <p class="card-text">This run is currently in the pre-start phase. It can started at any time.</p>`);
            fragments.push(startButton);
        } else {
            fragments.push(`
            <div class="alert alert-primary" role="alert">
                <p>This run is currently in the pre-start phase.</p>
                <p>Please ensure the following <i>before</i> starting the test:</p>
                <ul>`);
            for (const instruction of instructions) {
                fragments.push(`<li>${instruction}</li>`)
            }
            fragments.push(`</ul>`);
            fragments.push(startButton);
            fragments.push(`</div>`);
        }
        return fragments.join("");
    }

    function updateChart(timeline) {

        if (!timeline) {
            document.getElementById("timelineError").style = ""
            document.getElementById("timelineChart").style = "display: none;"
            return;
        } else {
            document.getElementById("timelineError").style = "display: none;"
            document.getElementById("timelineChart").style = ""
        }

        // Load the datasets and annotations (the only things that change between updates)
        const datasets = timeline.data_streams.map(ds => {
            return {
                label: ds.label,
                stepped: ds.stepped,
                borderDash: ds.dashed ? [5, 5] : undefined,
                data: ds.data,
                animation: false
            }
        });

        const annotations = [{
            type: 'line',
            borderColor: 'black',
            borderWidth: 1,
            display: (ctx) => ctx.chart.isDatasetVisible(1),
            label: {
                display: true,
                content: 'Now',
                position: 'start'
            },
            scaleID: 'x',
            value: timeline.now_offset
        }];
        if (timeline.set_max_w !== null && timeline.set_max_w !== undefined) {
            annotations.push({
                type: 'line',
                borderColor: 'black',
                borderWidth: 3,
                borderDash: [5, 5],
                scaleID: 'y',
                value: timeline.set_max_w
            });
            annotations.push({
                type: 'line',
                borderColor: 'black',
                borderWidth: 3,
                borderDash: [5, 5],
                scaleID: 'y',
                value: -timeline.set_max_w
            });
        }


        if (!timelineChart) {
            // We haven't rendered a chart yet
            timelineChart = new Chart(document.getElementById('timelineChart'),
                {
                    type: 'line',
                    data: {
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: true,
                        },
                        stacked: false,
                        plugins: {
                            annotation: {
                                common: {
                                    drawTime: 'beforeDraw'
                                },
                                annotations: annotations
                            }
                        },
                        parsing: {
                            xAxisKey: 'offset',
                            yAxisKey: 'watts'
                        },
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: "Watts"
                                },
                                grid: {
                                    color: function (context) {
                                        if (context.tick.value == 0)
                                            return "#000000";
                                        else
                                            return undefined;
                                    },
                                },
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: "Relative Time"
                                }
                            }
                        }
                    }
                });
        } else {
            // We just need to update the existing chart
            timelineChart.data.datasets = datasets;
            timelineChart.options.plugins.annotation.annotations = annotations;
            timelineChart.update()
        }
    }
    function parseStatus(rawJsonString) {
        if (!rawJsonString) return null;

        try {
            return JSON.parse(rawJsonString);
        } catch (error) {
            console.error("Error parsing status content", error);
            console.error(rawJsonString);
            return null;
        }

    }

    function handleNewStatus(status) {

        if (status === null || status === undefined) {
            showCommsError("Failed to retrieve current status.");
            return;
        } else {
            showCommsError(null)
        }

        // update test initialisation text
        // the element 'update-initialised-card' will only exist in the dom if the test is in the init-phase.
        const instructions = status.instructions ?? []
        const initialisedCard = document.getElementById('update-initialised-card')
        if (initialisedCard !== null) {
            // Allow to work with older version of cactus runner that doesn't send the instruction in the runner status
            initialisedCard.innerHTML = initialisedCardBody(instructions);
        }

        // update precondition checks table
        const preconditionChecksTable = document.getElementById('update-precondition-checks-table');
        const preconditionChecks = status.precondition_checks ?? null;
        if (preconditionChecks) {
            preconditionChecksTable.innerHTML = preconditionChecksTableBody(preconditionChecks);
        } else {
            // If there aren't any precondition checks we remove the card entirely.
            const preconditionCard = document.getElementById('precondition-checks-card');
            if (preconditionCard) preconditionCard.remove();
        }

        // update cactus log entries
        document.getElementById('update-log-envoy').innerHTML = status.log_envoy ?? "No logs recorded";

        // update requests table
        const requestTable = document.getElementById('update-requests-table');
        requestTable.innerHTML = requestsTableBody(status.request_history ?? []).join("");

        // update steps table
        const stepsTable = document.getElementById('update-steps-table');
        stepsTable.innerHTML = stepStatusTableBody(status.step_status ?? {}).join("");

        // update criteria table
        const criteriaTable = document.getElementById('update-criteria-table');
        criteriaTable.innerHTML = criteriaTableBody(status.criteria ?? []).join("");

        // update generate table
        const generalTable = document.getElementById('update-general-table');
        generalTable.innerHTML = generalTableBody(status).join("");

        // update step instructions
        if ("{{run_status}}" === "started") {
            stepInstructionsEl = document.getElementById('step-instructions')
            if (instructions.length > 0) {
                stepInstructionsEl.innerHTML = alertBanner(getStepInstructions(instructions));
            } else {
                stepInstructionsEl.innerHTML = ""
            }
        }

        // update timeline chart
        updateChart(status.timeline);
    }

    function handleStatusError(status, content) {
        if (status === null) {
            console.error("AJAX error occurred.");
            window.location = "{{ url_for('run_status_page', run_id=run_id) }}"
        } else if (status === 410) {
            console.error("Received HTTP GONE - reloading page as test is finished:");
            window.location = "{{ url_for('run_status_page', run_id=run_id) }}"
        } else {
            console.error("Request failed with status and content:", status, content);
        }
    }

    function startPollingRunStatus(runStatusUri, pollRateMs) {
        function fetchStatus() {
            xhrRequest(runStatusUri, (content) => {
                setTimeout(fetchStatus, pollRateMs);

                const status = parseStatus(content);
                if (status === null) {
                    console.error("Received invalid status from poll with content:", content)
                }

                try {
                    handleNewStatus(status);
                } catch (error) {
                    console.error("Error during handleNewStatus", error);
                    showCommsError("Error parsing status object from test harness.");
                }


            }, (status, content) => {
                setTimeout(fetchStatus, pollRateMs);
                handleStatusError(status, content);
            });
        }

        setTimeout(fetchStatus, pollRateMs); // start the loop after initial poll delay
    }

    addEventListener("load", (event) => {
        // Load initial status at startup
        const initialStatusJson = atob("{{ initial_status_b64 }}");
        const status = parseStatus(initialStatusJson);
        try {
            handleNewStatus(status);
        } catch (error) {
            console.error("Error during handleNewStatus", error);
            showCommsError("Error parsing status object from test harness.");
        }


        // Start polling
        const uri = "{{ url_for('run_status_json', run_id=run_id) }}";
        const pollRateMs = 10000; // 10 seconds
        startPollingRunStatus(uri, pollRateMs);
    });



</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.5.0/chart.umd.js"
    integrity="sha512-D4pL3vNgjkHR/qq+nZywuS6Hg1gwR+UzrdBW6Yg8l26revKyQHMgPq9CLJ2+HHalepS+NuGw1ayCCsGXu9JCXA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.0/dist/chartjs-plugin-annotation.min.js"
    integrity="sha256-/wN4amD2yTzKz+D7tsLjxnHXkwhWo2ifLzkxE9jWVew=" crossorigin="anonymous"></script>

{% endblock %}